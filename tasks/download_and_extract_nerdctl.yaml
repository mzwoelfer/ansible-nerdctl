# Don't fail or chagne when nerdctl version throws an error
- name: Check if nerdctl is already installed
  ansible.builtin.command: nerdctl --version
  register: nerdctl_installed_output
  failed_when: false
  changed_when: false
  become_user: "{{ nerdctl_user }}"

# ==========================================================I==
# OFFLINE MODE: user provided archive path
# ============================================================
- name: Use provided nerdctl archive
  when: nerdctl_archive_path | length > 0
  block:
    - name: Check provided nerdctl archive exists
      ansible.builtin.stat:
        path: "{{ nerdctl_archive_path }}"
      register: nerdctl_archive_stat

    - name: Fail if provided nerdctl archive does not exist
      ansible.builtin.fail:
        msg: "Provided nerdctl_archive_path does not exist: {{ nerdctl_archive_path }}"
      when: not nerdctl_archive_stat.stat.exists

    - name: Set effective nerdctl archive path (offline)
      set_fact:
        nerdctl_effective_archive_path: "{{ nerdctl_archive_path }}"

    - name: Force install when using local archive
      set_fact:
        nerdctl_needs_update: true

# ============================================================
# ONLINE MODE: GitHub download
# ============================================================
- name: Online (GitHub download) install
  when: nerdctl_archive_path | length == 0
  block:
  - name: Extract installed version
    set_fact: 
      nerdctl_installed_version: "{{ nerdctl_installed_output.stdout | regex_search('[\\d\\.]+') }}"
    when: nerdctl_installed_output.rc == 0

  - name: Check latest nerdctl version from github
    block:
      - name: Get latest nerdctl version from GitHub
        ansible.builtin.uri:
          url: "https://github.com/containerd/nerdctl/releases/latest"
          method: HEAD
          follow_redirects: none
          status_code: 302
        register: response
        changed_when: false
        when: nerdctl_version == "latest"

      - name: Set latest available nerdctl version
        set_fact:
          nerdctl_version: "{{ (response.location | regex_search('tag/v?([0-9.]+)$', '\\1') | first) }}"
        when: nerdctl_version == "latest"

  - name: Determine if nerdctl needs update
    set_fact:
      nerdctl_needs_update: "{{ nerdctl_installed_version is not defined or nerdctl_installed_version != nerdctl_version }}"

  - name: Set archive URLs
    set_fact: 
      nerdctl_archive: "nerdctl-full-{{ nerdctl_version }}-linux-amd64.tar.gz"
    when: nerdctl_needs_update

  - name: Set nerdctl download URL
    set_fact:
      nerdctl_download_url: "https://github.com/containerd/nerdctl/releases/download/v{{ nerdctl_version }}/{{ nerdctl_archive }}"
    when: nerdctl_needs_update

  - name: Set archive path for extraction
    set_fact:
      nerdctl_effective_archive_path: "/tmp/{{ nerdctl_archive }}"
    when: nerdctl_needs_update

  - name: Download nerdctl if not already installed
    ansible.builtin.get_url:
      url: "{{ nerdctl_download_url }}"
      dest: "{{ nerdctl_effective_archive_path }}"
      mode: 0755
      owner: "{{ nerdctl_user }}"
    become_user: "{{ nerdctl_user }}"
    when: nerdctl_needs_update

# ============================================================
# EXTRACTION 
# ============================================================
- name: "Extract nerdctl to install prefix: {{ nerdctl_install_prefix }}"
  become: true
  ansible.builtin.unarchive:
    src: "{{ nerdctl_effective_archive_path }}"
    dest: "{{ nerdctl_install_prefix }}"
    remote_src: true
  when: nerdctl_needs_update
  notify: Reload systemd units

